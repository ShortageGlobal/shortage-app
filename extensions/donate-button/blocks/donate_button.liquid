
<div class="donate_wrapper"></div>

<script>
var product_id = {{product.id}};
var tunel_url = 'https://hosts-modelling-asin-parking.trycloudflare.com';
var productPar = [];

document.addEventListener('DOMContentLoaded', function() {
	function getPair() {		
		if(!product_id) return;

		fetch(tunel_url + '/pair?prodId='+ product_id).then(res => res.json()).then(data => {
			console.log("ðŸš€ ~ data:", data);
			if(data && data.exists) injectButton();
			productPar = data.product;
		})
	}

	function getQuantity() {
		return document.querySelector('[name="quantity"]') ? document.querySelector('[name="quantity"]').value : 1;
	}

	function getProdVarId() {
		const params = window.location.search.split('variant=');
		if (params.length > 1) {
			return params[1].split('&')[0];
		}
		return document.querySelector('[name="id"]') ? document.querySelector('[name="id"]').value : null;
	}

	async function getOrganisationInfo() {
		if (!productPar) return;

		const response = await fetch(tunel_url + '/organization?organizationSlug=' + productPar.shortageOrganizationId);
		const data = await response.json();
		console.log("ðŸš€ ~ getOrganisationInfo:", data);
		return data && data.exists ? data.organization : null;
	}

	async function donateThis(productVariantId = getProdVarId(), qty = getQuantity()) {
		console.log('donateThis for: ', productVariantId);
		if(!productVariantId) return;

		const organization = await getOrganisationInfo();
		if (!organization) return console.error('Organization not found!');

		fetch('/cart/add.js', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				items: [{
				id: productVariantId,
				quantity: qty,
				properties: {
					'For Donation': 'Yes',
					'Shipping Name': organization.name,
					'Shipping Phone': organization.phone_number,
					'Shipping City': organization.country + ', ' + organization.state_province_region + ', ' + organization.city + ', ' + organization.zip,
					'Shipping Address': organization.address_line1 + ', ' + (organization.address_line2 ? organization.address_line2 : ''),
				}
				}]
			})
		}).then(response => response.json())
		.then(data => console.log(data))
		.catch((error) => console.error('Error:', error));
	}

	function injectButton(txt = 'Donate this') {
		document.querySelector('.donate_wrapper').appendChild(Object.assign(document.createElement('button'), {
			innerHTML: txt,
			id: 'newButtonId',
			className: 'my-custom-class',
			style: 'width: 100%; background: darkorange; border: navajowhite; line-height: 40px; margin-top: 10px; font-size: 14px;cursor: pointer;',
			onclick: () => donateThis()
		}));
	}


	var productJson = document.querySelector('script[type="application/json"]');
	if (productJson) {
		var productData = JSON.parse(productJson.innerText);
		if (productData && productData.product) {
			console.log("Product ID:", productData.product.id);
		}
	}	

	//preview in editor mode
	if (window.location.href.includes('oseid')) {
		injectButton();
	} else {
		getPair();
	}
}); 
</script>

<style>
	div[id^="shopify-block-shortage2_donate_button_"] {
		margin: -25px 0 0 0;
	}
</style>

{% schema %}
{
	"name": "Donate Button",
	"target": "section",
	"settings": []
}
{% endschema %}

